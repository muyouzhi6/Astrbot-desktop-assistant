# æ¶æ„è®¾è®¡æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ AstrBot Desktop Assistant çš„ç³»ç»Ÿæ¶æ„ã€æ ¸å¿ƒæ¨¡å—å’Œè®¾è®¡æ¨¡å¼ã€‚

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ¶æ„å›¾](#æ¶æ„å›¾)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [è®¾è®¡æ¨¡å¼](#è®¾è®¡æ¨¡å¼)
- [æ•°æ®æµ](#æ•°æ®æµ)
- [é€šä¿¡åè®®](#é€šä¿¡åè®®)
- [æ‰©å±•æŒ‡å—](#æ‰©å±•æŒ‡å—)

---

## ç³»ç»Ÿæ¦‚è¿°

AstrBot Desktop Assistant æ˜¯ä¸€ä¸ªåŸºäº PySide6 çš„è·¨å¹³å°æ¡Œé¢å®¢æˆ·ç«¯ï¼Œé‡‡ç”¨**æ‚¬æµ®çƒ + å¯¹è¯çª—å£**çš„äº¤äº’æ¨¡å¼ï¼Œä¸ AstrBot æœåŠ¡ç«¯é€šè¿‡ WebSocket è¿›è¡Œå®æ—¶é€šä¿¡ã€‚

### æŠ€æœ¯æ ˆ

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| GUI æ¡†æ¶ | PySide6 (Qt6) |
| å¼‚æ­¥æ¡†æ¶ | asyncio + qasync |
| HTTP å®¢æˆ·ç«¯ | httpx |
| é…ç½®ç®¡ç† | Pydantic |
| å±å¹•æˆªå›¾ | mss + Pillow |
| Markdown | markdown + pygments |

### è®¾è®¡åŸåˆ™

1. **æ¨¡å—åŒ–**ï¼šå„æ¨¡å—èŒè´£å•ä¸€ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
2. **è·¨å¹³å°**ï¼šé€šè¿‡å¹³å°é€‚é…å™¨æŠ½è±¡ç³»ç»Ÿå·®å¼‚
3. **å“åº”å¼**ï¼šé‡‡ç”¨ Qt ä¿¡å·æ§½æœºåˆ¶å®ç°ç»„ä»¶é—´é€šä¿¡
4. **å¼‚æ­¥ä¼˜å…ˆ**ï¼šä½¿ç”¨ asyncio å¤„ç† I/O æ“ä½œ

---

## æ¶æ„å›¾

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AstrBot Desktop Client                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Presentation Layer                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ FloatingBallâ”‚  â”‚ ChatWidgetsâ”‚  â”‚ SettingsWindow    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ SystemTray â”‚  â”‚   Themes   â”‚  â”‚ ScreenshotSelector â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Application Layer                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚    App     â”‚  â”‚ Controllersâ”‚  â”‚     Handlers       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚  â”‚ (Settings) â”‚  â”‚ (Msg/Screenshot/   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚  â”‚            â”‚  â”‚  Proactive/Media)  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Domain Layer                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚   Bridge   â”‚  â”‚  Services  â”‚  â”‚    Platforms       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (Message)  â”‚  â”‚ (Monitor/  â”‚  â”‚ (Win/Mac/Linux)    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚            â”‚  â”‚  Capture)  â”‚  â”‚                    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Infrastructure Layer                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ API Client â”‚  â”‚   Config   â”‚  â”‚     Storage        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (HTTP/WS)  â”‚  â”‚ (Pydantic) â”‚  â”‚ (ChatHistory)      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ WebSocket / HTTP
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AstrBot Server                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              astrbot_plugin_desktop_assistant               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  WSHandler   â”‚  â”‚DesktopMonitorâ”‚  â”‚ProactiveDialog   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—ä¾èµ–å›¾

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚       App       â”‚
                    â”‚  (DesktopClient â”‚
                    â”‚     App)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚                 â”‚
           â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     GUI      â”‚  â”‚   Handlers   â”‚  â”‚  Controllers â”‚
    â”‚  Components  â”‚  â”‚              â”‚  â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
           â”‚    â”‚                         â”‚    â”‚
           â–¼    â–¼                         â–¼    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Bridge    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Services   â”‚
    â”‚  (Message)   â”‚                â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
           â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  API Client  â”‚                â”‚  Platforms   â”‚
    â”‚  (HTTP/WS)   â”‚                â”‚ (Adapters)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    Config    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¨¡å—

### 1. GUI æ¨¡å— (`gui/`)

è´Ÿè´£ç”¨æˆ·ç•Œé¢å±•ç¤ºå’Œäº¤äº’ã€‚

#### 1.1 æ‚¬æµ®çƒ ([`floating_ball.py`](../desktop_client/gui/floating_ball.py))

```python
class FloatingBallWindow(QWidget):
    """
    æ‚¬æµ®çƒä¸»çª—å£
    
    åŠŸèƒ½ï¼š
    - æ‹–æ‹½ç§»åŠ¨ä¸è¾¹ç¼˜å¸é™„
    - å•å‡»åˆ‡æ¢è¾“å…¥æ¡†
    - åŒå‡»è§¦å‘ä¸»åŠ¨å¯¹è¯
    - å³é”®èœå•
    - æ¶ˆæ¯æ°”æ³¡æ˜¾ç¤º
    - å‘¼å¸ç¯çŠ¶æ€æç¤º
    
    ä¿¡å·ï¼š
    - clicked: å•å‡»äº‹ä»¶
    - double_clicked: åŒå‡»äº‹ä»¶
    - message_sent: æ¶ˆæ¯å‘é€
    - image_sent: å›¾ç‰‡å‘é€
    - screenshot_requested: æˆªå›¾è¯·æ±‚
    - settings_requested: è®¾ç½®è¯·æ±‚
    - quit_requested: é€€å‡ºè¯·æ±‚
    """
```

#### 1.2 èŠå¤©ç»„ä»¶ ([`chat_widgets.py`](../desktop_client/gui/chat_widgets.py))

```python
class ChatWidget(QWidget):
    """
    èŠå¤©ç•Œé¢ç»„ä»¶
    
    åŠŸèƒ½ï¼š
    - Markdown æ¸²æŸ“ï¼ˆä»£ç é«˜äº®ã€è¡¨æ ¼ã€å…¬å¼ï¼‰
    - æ¶ˆæ¯æ°”æ³¡å±•ç¤º
    - å›¾ç‰‡é¢„è§ˆä¸ç¼©æ”¾
    - æ¶ˆæ¯è¾“å…¥ä¸å‘é€
    """
```

#### 1.3 ä¸»é¢˜ç³»ç»Ÿ ([`themes.py`](../desktop_client/gui/themes.py))

```python
class ThemeManager:
    """
    ä¸»é¢˜ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
    
    åŠŸèƒ½ï¼š
    - äº®è‰²/æš—è‰²ä¸»é¢˜åˆ‡æ¢
    - è‡ªå®šä¹‰é¢œè‰²é…ç½®
    - ç³»ç»Ÿä¸»é¢˜è·Ÿéš
    
    ä½¿ç”¨ï¼š
    >>> from gui.themes import theme_manager
    >>> theme_manager.set_theme("dark")
    >>> colors = theme_manager.get_colors()
    """
```

### 2. Handler æ¨¡å— (`handlers/`)

å¤„ç†å„ç±»äº‹ä»¶å’Œæ¶ˆæ¯ã€‚

#### 2.1 æ¶ˆæ¯å¤„ç†å™¨ ([`message_handler.py`](../desktop_client/handlers/message_handler.py))

```python
class MessageHandler(QObject):
    """
    æ¶ˆæ¯å¤„ç†å™¨
    
    èŒè´£ï¼š
    - è§£ææœåŠ¡ç«¯å“åº”æ¶ˆæ¯
    - å¤„ç†æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ç­‰æ¶ˆæ¯ç±»å‹
    - æ›´æ–°èŠå¤©å†å²
    - è§¦å‘ UI æ›´æ–°
    
    ä¿¡å·ï¼š
    - message_processed: æ¶ˆæ¯å¤„ç†å®Œæˆ
    """
```

#### 2.2 æˆªå›¾å¤„ç†å™¨ ([`screenshot_handler.py`](../desktop_client/handlers/screenshot_handler.py))

```python
class ScreenshotHandler(QObject):
    """
    æˆªå›¾å¤„ç†å™¨
    
    èŒè´£ï¼š
    - å…¨å±æˆªå›¾
    - åŒºåŸŸæˆªå›¾
    - ä¸»åŠ¨å¯¹è¯æˆªå›¾
    - æˆªå›¾ç¼–ç ä¸å‘é€
    
    ä¿¡å·ï¼š
    - screenshot_completed: æˆªå›¾å®Œæˆ
    - proactive_screenshot_completed: ä¸»åŠ¨æˆªå›¾å®Œæˆ
    """
```

#### 2.3 ä¸»åŠ¨å¯¹è¯å¤„ç†å™¨ ([`proactive_handler.py`](../desktop_client/handlers/proactive_handler.py))

```python
class ProactiveHandler(QObject):
    """
    ä¸»åŠ¨å¯¹è¯å¤„ç†å™¨
    
    èŒè´£ï¼š
    - å¤„ç†ä¸»åŠ¨å¯¹è¯è§¦å‘äº‹ä»¶
    - ç»„è£…æ¡Œé¢çŠ¶æ€ä¿¡æ¯
    - å‘é€è‡³æœåŠ¡ç«¯è¿›è¡Œåˆ†æ
    """
```

#### 2.4 åª’ä½“å¤„ç†å™¨ ([`media_handler.py`](../desktop_client/handlers/media_handler.py))

```python
class MediaHandler(QObject):
    """
    åª’ä½“æ–‡ä»¶å¤„ç†å™¨
    
    èŒè´£ï¼š
    - ä¸‹è½½å›¾ç‰‡/è¯­éŸ³æ–‡ä»¶
    - è¯­éŸ³æ¶ˆæ¯è‡ªåŠ¨æ’­æ”¾
    - æ–‡ä»¶å­˜å‚¨ç®¡ç†
    """
```

### 3. Platform æ¨¡å— (`platforms/`)

å®ç°è·¨å¹³å°åŠŸèƒ½æŠ½è±¡ã€‚

#### 3.1 å¹³å°é€‚é…å™¨åŸºç±» ([`base.py`](../desktop_client/platforms/base.py))

```python
class IPlatformAdapter(ABC):
    """
    å¹³å°é€‚é…å™¨æŠ½è±¡åŸºç±»
    
    å®šä¹‰è·¨å¹³å°ç»Ÿä¸€æ¥å£ï¼š
    - get_active_window(): è·å–æ´»åŠ¨çª—å£ä¿¡æ¯
    - get_running_apps(): è·å–è¿è¡Œä¸­çš„åº”ç”¨
    - enable_autostart(): å¯ç”¨å¼€æœºè‡ªå¯
    - disable_autostart(): ç¦ç”¨å¼€æœºè‡ªå¯
    - is_autostart_enabled(): æ£€æŸ¥è‡ªå¯çŠ¶æ€
    """
```

#### 3.2 å¹³å°å®ç°

| å¹³å° | æ–‡ä»¶ | ç‰¹ç‚¹ |
|------|------|------|
| Windows | [`windows.py`](../desktop_client/platforms/windows.py) | ä½¿ç”¨ pywin32 è·å–çª—å£ä¿¡æ¯ |
| macOS | [`macos.py`](../desktop_client/platforms/macos.py) | ä½¿ç”¨ AppKit å’Œ AppleScript |
| Linux | [`linux.py`](../desktop_client/platforms/linux.py) | æ”¯æŒ X11 å’Œ Wayland |

```python
# ä½¿ç”¨ç¤ºä¾‹
from platforms import get_platform_adapter

adapter = get_platform_adapter()
window_info = adapter.get_active_window()
print(f"å½“å‰çª—å£: {window_info.title}")
print(f"è¿›ç¨‹: {window_info.process}")
```

### 4. Service æ¨¡å— (`services/`)

å°è£…æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚

#### 4.1 æ¡Œé¢ç›‘æ§æœåŠ¡ ([`desktop_monitor.py`](../desktop_client/services/desktop_monitor.py))

```python
class DesktopMonitorService:
    """
    æ¡Œé¢çŠ¶æ€ç›‘æ§æœåŠ¡
    
    åŠŸèƒ½ï¼š
    - å®šæ—¶æ•è·æ¡Œé¢çŠ¶æ€
    - çª—å£å˜åŒ–æ£€æµ‹
    - æˆªå›¾é‡‡é›†
    - çŠ¶æ€ä¸ŠæŠ¥
    
    ä½¿ç”¨ï¼š
    >>> monitor = DesktopMonitorService(
    ...     screen_capture_service=screen_capture,
    ...     report_interval=60
    ... )
    >>> await monitor.start()
    """
```

#### 4.2 å±å¹•æ•è·æœåŠ¡ ([`screen_capture.py`](../desktop_client/services/screen_capture.py))

```python
class ScreenCaptureService:
    """
    å±å¹•æ•è·æœåŠ¡
    
    åŠŸèƒ½ï¼š
    - å…¨å±æˆªå›¾
    - åŒºåŸŸæˆªå›¾
    - å›¾ç‰‡å‹ç¼©
    - Base64 ç¼–ç 
    """
```

#### 4.3 ä¸»åŠ¨å¯¹è¯æœåŠ¡ ([`proactive_dialog.py`](../desktop_client/services/proactive_dialog.py))

```python
class ProactiveDialogService(QObject):
    """
    ä¸»åŠ¨å¯¹è¯æœåŠ¡
    
    åŠŸèƒ½ï¼š
    - å®šæ—¶æ£€æŸ¥è§¦å‘æ¡ä»¶
    - æ¦‚ç‡è§¦å‘ä¸»åŠ¨å¯¹è¯
    - æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯
    
    ä¿¡å·ï¼š
    - dialog_triggered: å¯¹è¯è§¦å‘
    """
```

### 5. Bridge æ¨¡å— ([`bridge.py`](../desktop_client/bridge.py))

æ¶ˆæ¯æ¡¥æ¥å±‚ï¼Œç»Ÿä¸€ç®¡ç†æ¶ˆæ¯æ”¶å‘ã€‚

```python
class MessageBridge(QObject):
    """
    æ¶ˆæ¯æ¡¥æ¥å±‚
    
    èŒè´£ï¼š
    - å°è£… API Client
    - ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
    - ç®¡ç†è¿æ¥çŠ¶æ€
    - ä¿¡å·åˆ†å‘
    
    ä¿¡å·ï¼š
    - message_received: æ”¶åˆ°æ¶ˆæ¯
    - connection_state_changed: è¿æ¥çŠ¶æ€å˜åŒ–
    
    ä½¿ç”¨ï¼š
    >>> bridge = MessageBridge(config)
    >>> await bridge.connect_server()
    >>> await bridge.send_input(InputMessage(...))
    """
```

### 6. API Client æ¨¡å— ([`api_client.py`](../desktop_client/api_client.py))

åº•å±‚é€šä¿¡å®¢æˆ·ç«¯ã€‚

```python
class DesktopAPIClient:
    """
    API å®¢æˆ·ç«¯
    
    åŠŸèƒ½ï¼š
    - HTTP è¯·æ±‚ï¼ˆç™»å½•ã€æ–‡ä»¶ä¸Šä¼ ï¼‰
    - WebSocket é•¿è¿æ¥
    - SSE æµå¼å“åº”
    - è‡ªåŠ¨é‡è¿
    
    æ”¯æŒçš„æ¶ˆæ¯ç±»å‹ï¼š
    - text: æ–‡æœ¬æ¶ˆæ¯
    - image: å›¾ç‰‡æ¶ˆæ¯
    - voice: è¯­éŸ³æ¶ˆæ¯
    - desktop_state: æ¡Œé¢çŠ¶æ€
    """
```

---

## è®¾è®¡æ¨¡å¼

### 1. å¹³å°é€‚é…å™¨æ¨¡å¼ (Adapter Pattern)

è§£å†³è·¨å¹³å°å·®å¼‚é—®é¢˜ã€‚

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  IPlatformAdapter     â”‚ â—„â”€â”€â”€ æŠ½è±¡æ¥å£
        â”‚  (Abstract Base)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Windows     â”‚ â”‚    macOS     â”‚ â”‚    Linux     â”‚
â”‚  Adapter     â”‚ â”‚   Adapter    â”‚ â”‚   Adapter    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ–¹å¼**ï¼š

```python
# platforms/__init__.py
def get_platform_adapter() -> IPlatformAdapter:
    """å·¥å‚æ–¹æ³•ï¼šæ ¹æ®å½“å‰å¹³å°è¿”å›å¯¹åº”é€‚é…å™¨"""
    import sys
    if sys.platform == "win32":
        from .windows import WindowsPlatformAdapter
        return WindowsPlatformAdapter()
    elif sys.platform == "darwin":
        from .macos import MacOSPlatformAdapter
        return MacOSPlatformAdapter()
    else:
        from .linux import LinuxPlatformAdapter
        return LinuxPlatformAdapter()
```

### 2. Handler é“¾æ¨¡å¼ (Chain of Responsibility)

æ¶ˆæ¯å¤„ç†çš„èŒè´£é“¾ã€‚

```
æ¶ˆæ¯è¿›å…¥ â”€â”€â–º MessageHandler â”€â”€â–º MediaHandler â”€â”€â–º ProactiveHandler
                  â”‚                  â”‚                  â”‚
                  â–¼                  â–¼                  â–¼
              å¤„ç†æ–‡æœ¬           å¤„ç†åª’ä½“           å¤„ç†ä¸»åŠ¨å¯¹è¯
```

**ç‰¹ç‚¹**ï¼š

- æ¯ä¸ª Handler ä¸“æ³¨å•ä¸€èŒè´£
- å¯çµæ´»ç»„åˆå’Œæ‰©å±•
- é€šè¿‡ Qt ä¿¡å·æ§½å®ç°è§£è€¦

### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

åŸºäº Qt ä¿¡å·æ§½å®ç°ç»„ä»¶é—´é€šä¿¡ã€‚

```python
# å®šä¹‰ä¿¡å·
class MessageBridge(QObject):
    message_received = Signal(OutputMessage)
    connection_state_changed = Signal(ConnectionState)

# è¿æ¥ä¿¡å·åˆ°æ§½
bridge.message_received.connect(message_handler.handle_output_message)
bridge.connection_state_changed.connect(app.on_connection_state_changed)
```

### 4. å•ä¾‹æ¨¡å¼ (Singleton Pattern)

ç”¨äºå…¨å±€å”¯ä¸€çš„ç®¡ç†å™¨ã€‚

```python
# themes.py
class ThemeManager:
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance

# å…¨å±€è®¿é—®
theme_manager = ThemeManager()
```

### 5. MVC å˜ä½“æ¨¡å¼

åˆ†ç¦»å…³æ³¨ç‚¹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    View      â”‚â—„â”€â”€â”€â”‚  Controller  â”‚â”€â”€â”€â–ºâ”‚   Model  â”‚   â”‚
â”‚  â”‚   (GUI)      â”‚    â”‚ (Handlers/   â”‚    â”‚ (Config/ â”‚   â”‚
â”‚  â”‚              â”‚    â”‚  Controllers)â”‚    â”‚  Bridge) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                   â”‚                  â”‚        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                      Qt Signals                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æµ

### 1. ç”¨æˆ·æ¶ˆæ¯å‘é€æµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FloatingBall â”‚  message_sent ä¿¡å·
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     App      â”‚  _on_message_sent()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bridge     â”‚  send_input(InputMessage)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Client  â”‚  WebSocket å‘é€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   AstrBot Server
```

### 2. æœåŠ¡ç«¯æ¶ˆæ¯æ¥æ”¶æµç¨‹

```
   AstrBot Server
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Client  â”‚  WebSocket æ¥æ”¶
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bridge     â”‚  message_received ä¿¡å·
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MessageHandlerâ”‚  handle_output_message()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€ æ–‡æœ¬æ¶ˆæ¯ â”€â”€â–º æ›´æ–°èŠå¤©ç•Œé¢
       â”‚
       â”œâ”€â”€â”€ å›¾ç‰‡æ¶ˆæ¯ â”€â”€â–º MediaHandler ä¸‹è½½ â”€â”€â–º æ˜¾ç¤ºå›¾ç‰‡
       â”‚
       â””â”€â”€â”€ è¯­éŸ³æ¶ˆæ¯ â”€â”€â–º MediaHandler ä¸‹è½½ â”€â”€â–º è‡ªåŠ¨æ’­æ”¾
```

### 3. ä¸»åŠ¨å¯¹è¯è§¦å‘æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ProactiveDialogSvc  â”‚  å®šæ—¶æ£€æŸ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    è§¦å‘æ¡ä»¶æ»¡è¶³ï¼Ÿ
          â”‚
          â–¼ Yes
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScreenshotHandler  â”‚  æ•è·æˆªå›¾
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ProactiveHandler    â”‚  ç»„è£…çŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bridge           â”‚  å‘é€ desktop_state
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   AstrBot Server
          â”‚
          â–¼
    AI åˆ†æå¹¶å“åº”
```

---

## é€šä¿¡åè®®

### WebSocket æ¶ˆæ¯æ ¼å¼

#### 1. å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯

**æ–‡æœ¬æ¶ˆæ¯**ï¼š

```json
{
    "type": "text",
    "content": "ä½ å¥½",
    "session_id": "user_12345"
}
```

**å›¾ç‰‡æ¶ˆæ¯**ï¼š

```json
{
    "type": "image",
    "content": "/path/to/image.png",
    "session_id": "user_12345",
    "metadata": {
        "text": "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ"
    }
}
```

**æ¡Œé¢çŠ¶æ€**ï¼š

```json
{
    "type": "desktop_state",
    "data": {
        "timestamp": "2024-01-01T12:00:00",
        "active_window_title": "Visual Studio Code",
        "active_window_process": "Code.exe",
        "active_window_pid": 12345,
        "screenshot_base64": "iVBORw0KGgo...",
        "screenshot_width": 800,
        "screenshot_height": 600,
        "running_apps": [
            {"pid": 12345, "name": "Code.exe"},
            {"pid": 67890, "name": "chrome.exe"}
        ],
        "window_changed": true,
        "previous_window_title": "Chrome"
    }
}
```

#### 2. æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯

**æ–‡æœ¬å“åº”**ï¼š

```json
{
    "type": "text",
    "content": "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ"
}
```

**å›¾ç‰‡å“åº”**ï¼š

```json
{
    "type": "image",
    "url": "https://server/images/response.png"
}
```

**è¯­éŸ³å“åº”**ï¼š

```json
{
    "type": "voice",
    "url": "https://server/audio/response.mp3"
}
```

---

## æ‰©å±•æŒ‡å—

### 1. æ·»åŠ æ–°å¹³å°é€‚é…å™¨

```python
# platforms/new_platform.py

from .base import IPlatformAdapter, WindowInfo, AppInfo, Result

class NewPlatformAdapter(IPlatformAdapter):
    """æ–°å¹³å°é€‚é…å™¨"""
    
    @property
    def platform_name(self) -> str:
        return "new_platform"
    
    def get_active_window(self) -> WindowInfo:
        # å®ç°è·å–æ´»åŠ¨çª—å£é€»è¾‘
        pass
    
    def get_running_apps(self, max_count: int = 50) -> List[AppInfo]:
        # å®ç°è·å–è¿è¡Œåº”ç”¨åˆ—è¡¨é€»è¾‘
        pass
    
    def enable_autostart(self) -> Result:
        # å®ç°å¯ç”¨å¼€æœºè‡ªå¯é€»è¾‘
        pass
    
    def disable_autostart(self) -> Result:
        # å®ç°ç¦ç”¨å¼€æœºè‡ªå¯é€»è¾‘
        pass
    
    def is_autostart_enabled(self) -> bool:
        # å®ç°æ£€æŸ¥è‡ªå¯çŠ¶æ€é€»è¾‘
        pass
```

### 2. æ·»åŠ æ–°æ¶ˆæ¯å¤„ç†å™¨

```python
# handlers/new_handler.py

from PySide6.QtCore import QObject, Signal

class NewHandler(QObject):
    """æ–°æ¶ˆæ¯å¤„ç†å™¨"""
    
    # å®šä¹‰ä¿¡å·
    processing_completed = Signal(object)
    
    def __init__(self, config, parent=None):
        super().__init__(parent)
        self.config = config
    
    def handle_message(self, message):
        """å¤„ç†æ¶ˆæ¯"""
        # å®ç°å¤„ç†é€»è¾‘
        result = self._process(message)
        self.processing_completed.emit(result)
    
    def _process(self, message):
        # å…·ä½“å¤„ç†é€»è¾‘
        pass
```

### 3. æ·»åŠ æ–° GUI ç»„ä»¶

```python
# gui/new_widget.py

from PySide6.QtWidgets import QWidget
from PySide6.QtCore import Signal

class NewWidget(QWidget):
    """æ–° GUI ç»„ä»¶"""
    
    # å®šä¹‰ä¿¡å·
    action_triggered = Signal(str)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self._init_ui()
    
    def _init_ui(self):
        """åˆå§‹åŒ– UI"""
        # å¸ƒå±€å’Œæ§ä»¶è®¾ç½®
        pass
```

### 4. æ·»åŠ æ–°æœåŠ¡

```python
# services/new_service.py

from typing import Optional
import asyncio

class NewService:
    """æ–°æœåŠ¡"""
    
    def __init__(self, config):
        self.config = config
        self._running = False
        self._task: Optional[asyncio.Task] = None
    
    async def start(self):
        """å¯åŠ¨æœåŠ¡"""
        self._running = True
        self._task = asyncio.create_task(self._run())
    
    async def stop(self):
        """åœæ­¢æœåŠ¡"""
        self._running = False
        if self._task:
            self._task.cancel()
            await asyncio.gather(self._task, return_exceptions=True)
    
    async def _run(self):
        """æœåŠ¡ä¸»å¾ªç¯"""
        while self._running:
            await self._do_work()
            await asyncio.sleep(self.config.interval)
    
    async def _do_work(self):
        """æ‰§è¡Œå·¥ä½œ"""
        pass
```

---

## é™„å½•

### é…ç½®æ–‡ä»¶ç»“æ„

```json
{
    "server": {
        "url": "http://localhost:6185",
        "username": "",
        "password": "",
        "auto_reconnect": true,
        "reconnect_interval": 5,
        "max_reconnect_attempts": 10,
        "startup_delay": 3
    },
    "appearance": {
        "theme": "auto",
        "custom_theme": {}
    },
    "proactive": {
        "enabled": true,
        "check_interval": 600,
        "trigger_probability": 0.2,
        "screenshot_width": 800,
        "screenshot_height": 600
    },
    "storage": {
        "chat_history_path": "",
        "image_save_path": ""
    }
}
```

### æ—¥å¿—é…ç½®

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# æ¨¡å—æ—¥å¿—
logger = logging.getLogger(__name__)
logger.debug("è°ƒè¯•ä¿¡æ¯")
logger.info("ä¸€èˆ¬ä¿¡æ¯")
logger.warning("è­¦å‘Šä¿¡æ¯")
logger.error("é”™è¯¯ä¿¡æ¯")
```

---

*æœ€åæ›´æ–°ï¼š2024 å¹´ 12 æœˆ*